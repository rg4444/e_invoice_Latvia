{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>WS-Security debug â€“ GetInitialAddresseeRecordList</h2>

  <p class="text-muted">
    This page runs the official VDAA Java SDK against the DIV UnifiedServiceInterface
    <code>GetInitialAddresseeRecordList</code> operation.
  </p>
  <p class="text-muted small">
    Use the checkbox below to toggle the debug endpoint when needed. Otherwise the call uses the
    configured standard endpoint.
  </p>

  <div class="card mb-3">
    <div class="card-header">Engine availability</div>
    <div class="card-body">
      <ul class="list-unstyled mb-0">
        <li>
          <span class="badge bg-{{ 'success' if engine_caps.python.available else 'danger' }}">
            {{ 'Available' if engine_caps.python.available else 'Unavailable' }}
          </span>
          Python engine (custom WSSE)
        </li>
        <li>
          <span class="badge bg-{{ 'success' if engine_caps.dotnet.available else 'danger' }}">
            {{ 'Available' if engine_caps.dotnet.available else 'Unavailable' }}
          </span>
          .NET bridge ({{ engine_caps.dotnet.detail }})
        </li>
        <li>
          <span class="badge bg-{{ 'success' if engine_caps.java.available else 'danger' }}">
            {{ 'Available' if engine_caps.java.available else 'Unavailable' }}
          </span>
          Java bridge ({{ engine_caps.java.detail }})
        </li>
      </ul>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      Test parameters
    </div>
    <div class="card-body">
      <form id="wssec_form">
        <div class="mb-3">
          <label for="wssec_engine" class="form-label">SOAP Engine</label>
          <select class="form-select" id="wssec_engine" name="engine" disabled>
            <option value="java" selected>Java (VDAA SDK)</option>
          </select>
          <div class="form-text">
            This tab is locked to the Java SDK for CLI parity.
          </div>
        </div>

        <div class="mb-3">
          <label for="wssec_operation" class="form-label">Operation</label>
          <select class="form-select" id="wssec_operation" name="operation">
            <option value="GetInitialAddresseeRecordList" selected>GetInitialAddresseeRecordList</option>
          </select>
          <div class="form-text">
            Additional operations can be added later as needed.
          </div>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="wssec_use_debug" name="use_debug">
          <label class="form-check-label" for="wssec_use_debug">
            Use Debug endpoint
          </label>
        </div>

        <div class="mb-3">
          <label for="wssec_token" class="form-label">Token value (uui:Token)</label>
          <input type="text" class="form-control" id="wssec_token" name="token" placeholder="1">
          <div class="form-text">
            For the initial address list, this can usually be left blank or set to <code>1</code>.
          </div>
        </div>

        <div class="mb-3" id="wssec_cert_group">
          <label class="form-label">Certificate source (SDK engines)</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="wssec_use_config_certs" checked>
            <label class="form-check-label" for="wssec_use_config_certs">
              Use app config certs
            </label>
          </div>
          <div class="form-text">
            When checked, the SDK call uses the configured client certificate and key, or the configured
            PKCS#12 if present.
          </div>
          <div class="row mt-2 g-2">
            <div class="col-md-8">
              <input type="text" class="form-control" id="wssec_pfx_path" placeholder="Custom PFX path (optional)" value="{{ cfg.wssec_java_pfx_path }}">
            </div>
            <div class="col-md-4">
              <input type="password" class="form-control" id="wssec_pfx_password" placeholder="PFX password (optional)" value="{{ cfg.wssec_java_pfx_password }}">
            </div>
          </div>
        </div>

        <button type="button" id="wssec_run" class="btn btn-primary">
          Run SDK call
        </button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      Results
    </div>
    <div class="card-body">
      <pre id="wssec_result"
           class="bg-dark text-light p-3 rounded small"
           style="max-height: 420px; overflow-y: auto; font-family: monospace;"
           hidden></pre>
      <p class="text-muted mt-2 small">
        Each run saves the full request and response to
        <code>data/addresses/wssec_debug/</code> for offline inspection.
        The saved request XMLs will mention the debug endpoint to help VDAA match your tests with their logs.
      </p>
    </div>
  </div>
</div>

<script>
(async function() {
  const runBtn = document.getElementById('wssec_run');
  const resultBox = document.getElementById('wssec_result');
  const operationSelect = document.getElementById('wssec_operation');
  const useConfigCerts = document.getElementById('wssec_use_config_certs');
  const pfxPathInput = document.getElementById('wssec_pfx_path');
  const pfxPasswordInput = document.getElementById('wssec_pfx_password');

  function toggleCertInputs() {
    const useConfig = useConfigCerts.checked;
    pfxPathInput.disabled = useConfig;
    pfxPasswordInput.disabled = useConfig;
  }

  async function callWssecDebug() {
    const token = document.getElementById('wssec_token').value.trim();
    const engine = 'java';
    const useDebug = document.getElementById('wssec_use_debug').checked;
    const operation = operationSelect.value;
    if (!token) {
      // optional: allow blank token for experimentation
    }

    resultBox.hidden = false;
    resultBox.textContent = "Running SDK call...\n";

    try {
      const payload = {
        engine: engine,
        operation: operation,
        token: token,
        use_debug_endpoint: useDebug,
        use_app_config_certs: useConfigCerts.checked,
        pfx_path: pfxPathInput.value.trim(),
        pfx_password: pfxPasswordInput.value
      };
      const resp = await fetch('/api/wssec-debug/run-sdk-call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      let lines = [];
      if (!data.ok) {
        lines.push("Error: " + (data.error || data.fault_reason || "Unknown error"));
        if (data.fault_reason && data.error && data.fault_reason !== data.error) {
          lines.push("Fault reason: " + data.fault_reason);
        }
        if (data.stderr) {
          lines.push("stderr: " + data.stderr);
        }
      } else {
        lines.push("Engine: " + (data.engine || engine) + " | Operation: " + (data.operation || operation));
        lines.push("Endpoint: " + (data.endpoint || "?") + " (" + (data.endpoint_mode || "debug") + ")");
        lines.push("HTTP status: " + (data.http_status ?? "?") + " | Duration: " + (data.took_ms ?? "?") + " ms");
        const savedRequest = data.saved_request_path || data.request_saved_path;
        const savedResponse = data.saved_response_path || data.response_saved_path;
        if (savedRequest) {
          lines.push("Saved request: " + savedRequest);
        }
        if (savedResponse) {
          lines.push("Saved response: " + savedResponse);
        }
        if (data.soap_request_path) {
          lines.push("SOAP request: " + data.soap_request_path);
        }
        if (data.soap_response_path) {
          lines.push("SOAP response: " + data.soap_response_path);
        }
        if (data.fault_reason) {
          lines.push("Fault reason: " + data.fault_reason);
        }
        if (data.bridge_stdout) {
          lines.push("stdout: " + data.bridge_stdout);
        }
        if (data.stderr) {
          lines.push("stderr: " + data.stderr);
        }
      }

      resultBox.textContent = lines.join("\n") + "\n\n--- Raw JSON ---\n" +
                              JSON.stringify(data, null, 2);
    } catch (err) {
      resultBox.textContent += "\nERROR: " + err;
    }
  }

  useConfigCerts.addEventListener('change', toggleCertInputs);
  toggleCertInputs();
  runBtn.addEventListener('click', callWssecDebug);
})();
</script>
{% endblock %}
