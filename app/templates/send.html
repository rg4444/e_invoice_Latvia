{% extends "base.html" %}{% block content %}
<h2>Send & Debug</h2>
<p>Endpoint: <code>{{ cfg.endpoint }}</code></p>
<button id="load_wsdl" class="btn btn-secondary mb-3">Load WSDL</button>
<ul id="wsdl_ops" class="list-group mb-3"></ul>
<button id="send" class="btn btn-primary mb-3">Validate & Send</button>
<pre id="dbg" class="mt-3"></pre>
<script>
const cfg = {{ cfg | tojson | safe }};

document.getElementById('load_wsdl').addEventListener('click', async ()=>{
  const fd = new FormData();
  const res = await fetch('/wsdl/load', { method:'POST', body: fd });
  const js = await res.json();
  const ops = document.getElementById('wsdl_ops');
  ops.innerHTML = '';
  js.operations.forEach(op => {
    const li = document.createElement('li');
    li.textContent = `${op.name} (${op.soap_action})`;
    li.className = 'list-group-item list-group-item-action';
    li.style.cursor = 'pointer';
    li.addEventListener('click', async ()=>{
      const fd = new FormData();
      Object.entries(cfg).forEach(([k,v]) => fd.append(k, v));
      fd.set('soap_action', op.soap_action || '');
      await fetch('/save-config', { method:'POST', body: fd });
      cfg.soap_action = op.soap_action || '';
      const body = `<${op.name}></${op.name}>`;
      await fetch('/invoice/set', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({xml: body})});
      alert(`Selected operation ${op.name}`);
    });
    ops.appendChild(li);
  });
});

document.getElementById('send').addEventListener('click', async ()=>{
  // Optional: call /validate first and block on failure
  const v = await fetch('/validate', { method:'POST' }).then(r=>r.json());
  if (!v.ok) { alert("XSD validation failed — see Schema tab"); return; }

  const res = await fetch('/send', { method:'POST' });
  const json = await res.json();
  const d = json.debug;
  const ok = json.ok ? "✔" : "✖";
  const txt = [
    `${ok} HTTP ${d.response.status} in ${d.timing_ms} ms`,
    "",
    "== Request ==",
    `URL: ${d.request.url}`,
    "Headers:",
    JSON.stringify(d.request.headers, null, 2),
    "",
    "Body:",
    d.request.body,
    "",
    "== Response ==",
    "Headers:",
    JSON.stringify(d.response.headers, null, 2),
    "",
    "Body:",
    d.response.body
  ].join("\n");
  document.getElementById('dbg').textContent = txt;
});
</script>
{% endblock %}
