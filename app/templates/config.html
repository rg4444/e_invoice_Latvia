{% extends "base.html" %}{% block content %}
<h2>Configuration</h2>
<div class="mb-3">
  <button id="load_wsdl" class="btn btn-secondary mb-3">Load WSDL</button>
  <ul id="wsdl_ops" class="list-group"></ul>
  <div id="wsdl_err" class="text-danger"></div>
</div>
<h3>Find & Convert (OpenSSL)</h3>
<p>Choose a directory under <code>/data</code> that contains your certificate files.
I will look for: <code>.key</code> (private key), <code>.cer</code>/<code>.pem</code> (client cert), and <code>.p7b</code>/<code>.p7c</code> (chain).</p>
<p><strong>Security:</strong> This tool reads and writes private keys inside <code>/data</code>. Keep that directory local &amp; protected. We don't change key passwords; if your key is encrypted, OpenSSL may prompt for passphrases. The TLS probe uses <code>curl -v</code>; redact logs before sharing.</p>

<form id="finder">
  <label>Search directory (inside /data):
    <input name="dir" value="/data/certs">
  </label>
  <label>Output directory:
    <input name="out" value="/data/certs">
  </label>
  <label>Create PKCS#12 (.p12)
    <input type="checkbox" name="mkp12" checked>
  </label>
  <label>PKCS#12 password (optional)
    <input type="password" name="p12pass" value="">
  </label>
  <div>
    <button type="submit">Find and convert</button>
    <button id="verify" type="button">Verify chain &amp; TLS probe</button>
  </div>
</form>
<pre id="finder_out"></pre>

<script>
document.getElementById('finder').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/tools/find-convert', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('finder_out').textContent = JSON.stringify(js, null, 2);
  if (js.config_applied) alert('Converted and applied to config.');
});

document.getElementById('verify').addEventListener('click', async ()=>{
  const res = await fetch('/tools/verify', { method:'POST' });
  const js = await res.json();
  document.getElementById('finder_out').textContent = JSON.stringify(js, null, 2);
});
</script>
<hr>
<h3>Certificate Diagnostics</h3>
<p>This will inspect your certs/keys, verify the chain, and test TLS handshake to the endpoint.</p>

<form id="diag">
  <label>Allow creating a decrypted test key (client.key.decrypted.pem)?
    <input type="checkbox" name="allow_decrypt" />
  </label>
  <button type="submit">Run Diagnostics</button>
  <button id="fix" type="button">One-click Fix</button>
</form>
<pre id="diag_out"></pre>

<script>
document.getElementById('diag').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/tools/diagnose', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('diag_out').textContent = JSON.stringify(js, null, 2);
  if (js.apply_suggestion) alert('Auto-suggestion available. Click One-click Fix.');
});

document.getElementById('fix').addEventListener('click', async ()=>{
  const res = await fetch('/tools/auto-fix', { method:'POST' });
  const js = await res.json();
  document.getElementById('diag_out').textContent = JSON.stringify(js, null, 2);
});
</script>
<hr>
<form id="cfg">
  <div class="mb-3">
    <label for="endpoint" class="form-label">Endpoint</label>
    <input id="endpoint" name="endpoint" value="{{cfg.endpoint}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="soap_action" class="form-label">SOAPAction</label>
    <input id="soap_action" name="soap_action" value="{{cfg.soap_action}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="soap_version" class="form-label">SOAP Version</label>
    <select id="soap_version" name="soap_version" class="form-select">
      <option value="1.1" {% if cfg.soap_version == "1.1" %}selected{% endif %}>1.1</option>
      <option value="1.2" {% if cfg.soap_version != "1.1" %}selected{% endif %}>1.2</option>
    </select>
  </div>
  <div class="form-check mb-3">
    <input id="use_ws_addressing" type="checkbox" name="use_ws_addressing" class="form-check-input" {% if cfg.use_ws_addressing %}checked{% endif %}>
    <label for="use_ws_addressing" class="form-check-label">Use WS-Addressing</label>
  </div>
  <div class="mb-3">
    <label for="wsse_mode" class="form-label">WS-Security</label>
    <select id="wsse_mode" name="wsse_mode" class="form-select">
      <option value="none" {% if cfg.wsse_mode == "none" %}selected{% endif %}>None</option>
      <option value="username" {% if cfg.wsse_mode == "username" %}selected{% endif %}>UsernameToken</option>
      <option value="x509" {% if cfg.wsse_mode == "x509" %}selected{% endif %}>X.509</option>
    </select>
  </div>
  <div class="mb-3">
    <label for="username" class="form-label">Username</label>
    <input id="username" name="username" value="{{cfg.username}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password</label>
    <input id="password" type="password" name="password" value="{{cfg.password}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_cert" class="form-label">Client cert (PEM)</label>
    <input id="client_cert" name="client_cert" value="{{cfg.client_cert}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_key" class="form-label">Client key (PEM)</label>
    <input id="client_key" name="client_key" value="{{cfg.client_key}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_key_pass" class="form-label">Key passphrase (optional)</label>
    <input id="client_key_pass" type="password" name="client_key_pass" value="{{cfg.client_key_pass}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_p12" class="form-label">Client PKCS#12</label>
    <input id="client_p12" name="client_p12" value="{{cfg.client_p12}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="p12_password" class="form-label">P12 password</label>
    <input id="p12_password" type="password" name="p12_password" value="{{cfg.p12_password}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="ca_bundle" class="form-label">CA bundle (optional)</label>
    <input id="ca_bundle" name="ca_bundle" value="{{cfg.ca_bundle}}" class="form-control">
  </div>
  <div class="form-check mb-3">
    <input id="verify_tls" type="checkbox" name="verify_tls" class="form-check-input" {% if cfg.verify_tls %}checked{% endif %}>
    <label for="verify_tls" class="form-check-label">Verify TLS</label>
  </div>
  <div class="mb-3">
    <label for="schema_path" class="form-label">XSD entry</label>
    <input id="schema_path" name="schema_path" value="{{cfg.schema_path}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="success_indicator" class="form-label">Success indicator</label>
    <input id="success_indicator" name="success_indicator" value="{{cfg.success_indicator}}" class="form-control">
  </div>
  <button type="submit" class="btn btn-primary">Save</button>
</form>
<script>
const cfg = {{ cfg | tojson | safe }};
document.getElementById('load_wsdl').addEventListener('click', async ()=>{
  const fd = new FormData();
  const res = await fetch('/wsdl/load', { method:'POST', body: fd });
  const ops = document.getElementById('wsdl_ops');
  const err = document.getElementById('wsdl_err');
  ops.innerHTML = '';
  err.textContent = '';
  if (!res.ok) {
    err.textContent = 'Failed to load WSDL';
    return;
  }
  const js = await res.json();
  if (!js.operations || !js.operations.length) {
    err.textContent = 'No operations found';
    return;
  }
  js.operations.forEach(op => {
    const li = document.createElement('li');
    li.textContent = `${op.name} (${op.soap_action})`;
    li.className = 'list-group-item list-group-item-action';
    li.style.cursor = 'pointer';
    li.addEventListener('click', async ()=>{
      const fd = new FormData();
      Object.entries(cfg).forEach(([k,v]) => fd.append(k, v));
      fd.set('soap_action', op.soap_action || '');
      await fetch('/save-config', { method:'POST', body: fd });
      cfg.soap_action = op.soap_action || '';
      const body = `<${op.name}></${op.name}>`;
      await fetch('/invoice/set', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({xml: body})});
      alert(`Selected operation ${op.name}`);
    });
    ops.appendChild(li);
  });
});
</script>
<script>
document.getElementById('cfg').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/save-config', { method:'POST', body: fd });
  alert('Saved');
});
</script>
{% endblock %}
