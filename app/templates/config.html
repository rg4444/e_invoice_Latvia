{% extends "base.html" %}{% block content %}
<h2>Configuration</h2>

<h3>WSDL</h3>
<div class="grid">
  <label>Service URL (endpoint)
    <input id="wsdl_url" value="{{cfg.endpoint}}" class="form-control">
  </label>
  <label class="form-check">
    <input type="checkbox" id="prefer_multi" class="form-check-input" checked>
    <span class="form-check-label">Prefer ?wsdl (recommended)</span>
  </label>
</div>
<div class="mb-3">
  <button id="wsdl_load" class="btn btn-primary me-2">Load WSDL</button>
  <button id="wsdl_debug" class="btn btn-secondary">Debug WSDL</button>
</div>
<pre id="wsdl_out"></pre>
<div id="wsdl_suggest"></div>

<script>
document.getElementById('wsdl_load').addEventListener('click', async ()=>{
  const url = document.getElementById('wsdl_url').value;
  const prefer_multi = document.getElementById('prefer_multi').checked ? 'true' : 'false';
  const fd = new FormData();
  fd.append('url', url);
  fd.append('prefer_multi', prefer_multi);
  const res = await fetch('/wsdl/load', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('wsdl_out').textContent = JSON.stringify(js, null, 2);
  document.getElementById('wsdl_suggest').textContent = '';
});

document.getElementById('wsdl_debug').addEventListener('click', async ()=>{
  const url = document.getElementById('wsdl_url').value;
  const fd = new FormData();
  fd.append('url', url);
  fd.append('try_both', 'true');
  fd.append('use_curl_fallback', 'true');
  const res = await fetch('/wsdl/debug', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('wsdl_out').textContent = JSON.stringify(js, null, 2);
  const sug = (js.suggestions || []).map(s => `- ${s}`).join('\n');
  document.getElementById('wsdl_suggest').textContent = sug ? ("Suggestions:\n" + sug) : "";
});
</script>

<h3>Find & Convert (OpenSSL)</h3>
<p>Choose a directory under <code>/data</code> that contains your certificate files.
I will look for: <code>.key</code> (private key), <code>.cer</code>/<code>.pem</code> (client cert), and <code>.p7b</code>/<code>.p7c</code> (chain).</p>
<p><strong>Security:</strong> This tool reads and writes private keys inside <code>/data</code>. Keep that directory local &amp; protected. We don't change key passwords; if your key is encrypted, OpenSSL may prompt for passphrases. The TLS probe uses <code>curl -v</code>; redact logs before sharing.</p>

<form id="finder">
  <label>Search directory (inside /data):
    <input name="dir" value="/data/certs" class="form-control">
  </label>
  <label>Output directory:
    <input name="out" value="/data/certs" class="form-control">
  </label>
  <label class="form-check mt-2">Create PKCS#12 (.p12)
    <input type="checkbox" name="mkp12" class="form-check-input" checked>
  </label>
  <label>PKCS#12 password (optional)
    <input type="password" name="p12pass" value="" class="form-control">
  </label>
  <div class="mt-2">
    <button type="submit" class="btn btn-primary me-2">Find and convert</button>
    <button id="verify" type="button" class="btn btn-secondary">Verify chain &amp; TLS probe</button>
  </div>
</form>
<pre id="finder_out"></pre>

<script>
document.getElementById('finder').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/tools/find-convert', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('finder_out').textContent = JSON.stringify(js, null, 2);
  if (js.config_applied) alert('Converted and applied to config.');
});

document.getElementById('verify').addEventListener('click', async ()=>{
  const res = await fetch('/tools/verify', { method:'POST' });
  const js = await res.json();
  document.getElementById('finder_out').textContent = JSON.stringify(js, null, 2);
});
</script>
<hr>
<h3>Certificate Diagnostics</h3>
<p>This will inspect your certs/keys, verify the chain, and test TLS handshake to the endpoint.</p>

<form id="diag">
  <label class="form-check">Allow creating a decrypted test key (client.key.decrypted.pem)?
    <input type="checkbox" name="allow_decrypt" class="form-check-input" />
  </label>
  <button type="submit" class="btn btn-primary me-2">Run Diagnostics</button>
  <button id="fix" type="button" class="btn btn-secondary">One-click Fix</button>
</form>
<pre id="diag_out"></pre>

<script>
document.getElementById('diag').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/tools/diagnose', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('diag_out').textContent = JSON.stringify(js, null, 2);
  if (js.apply_suggestion) alert('Auto-suggestion available. Click One-click Fix.');
});

document.getElementById('fix').addEventListener('click', async ()=>{
  const res = await fetch('/tools/auto-fix', { method:'POST' });
  const js = await res.json();
  document.getElementById('diag_out').textContent = JSON.stringify(js, null, 2);
});
</script>
<hr>
<form id="cfg">
  <div class="mb-3">
    <label for="endpoint" class="form-label">Endpoint</label>
    <input id="endpoint" name="endpoint" value="{{cfg.endpoint}}" class="form-control" placeholder="https://divtest.vraa.gov.lv/Vraa.Div.WebService.UnifiedInterface/UnifiedService.svc">
    <div class="form-text">UnifiedService test endpoint: <code>https://divtest.vraa.gov.lv/Vraa.Div.WebService.UnifiedInterface/UnifiedService.svc</code></div>
  </div>
  <div class="mb-3">
    <label for="debug_endpoint" class="form-label">Debug endpoint</label>
    <input id="debug_endpoint" name="debug_endpoint" value="{{cfg.debug_endpoint}}" class="form-control" placeholder="https://divtest.vraa.gov.lv/Vraa.Div.WebService.UnifiedInterfaceDebug/UnifiedService.svc">
    <div class="form-text">WS-Security debug tab uses this endpoint (UnifiedInterfaceDebug). Leave blank to fall back to the test endpoint.</div>
  </div>
  <div class="mb-3">
    <label for="soap_action" class="form-label">SOAPAction</label>
    <input id="soap_action" name="soap_action" value="{{cfg.soap_action}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="soap_version" class="form-label">SOAP Version</label>
    <select id="soap_version" name="soap_version" class="form-select">
      <option value="1.1" {% if cfg.soap_version == "1.1" %}selected{% endif %}>1.1</option>
      <option value="1.2" {% if cfg.soap_version != "1.1" %}selected{% endif %}>1.2</option>
    </select>
  </div>
  <div class="form-check mb-3">
    <input id="use_ws_addressing" type="checkbox" name="use_ws_addressing" class="form-check-input" {% if cfg.use_ws_addressing %}checked{% endif %}>
    <label for="use_ws_addressing" class="form-check-label">Use WS-Addressing</label>
  </div>
  <div class="mb-3">
    <label for="wsse_mode" class="form-label">WS-Security</label>
    <select id="wsse_mode" name="wsse_mode" class="form-select">
      <option value="none" {% if cfg.wsse_mode == "none" %}selected{% endif %}>None</option>
      <option value="username" {% if cfg.wsse_mode == "username" %}selected{% endif %}>UsernameToken</option>
      <option value="x509" {% if cfg.wsse_mode == "x509" %}selected{% endif %}>X.509</option>
    </select>
    <div class="form-text">Leave the Username/Password fields empty to skip the UsernameToken and use only mutual TLS.</div>
  </div>
  <div class="mb-3">
    <label for="username" class="form-label">Username</label>
    <input id="username" name="username" value="{{cfg.username}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password</label>
    <input id="password" type="password" name="password" value="{{cfg.password}}" class="form-control">
    <div class="form-text">Provide the VDAA-issued SOAP credentials if available; otherwise leave blank so no WS-Security UsernameToken is sent.</div>
  </div>
  <div class="mb-3">
    <label for="client_cert" class="form-label">Client cert (PEM)</label>
    <input id="client_cert" name="client_cert" value="{{cfg.client_cert}}" class="form-control" placeholder="/data/certs/client_full.pem">
    <div class="form-text">Use the combined leaf + chain file from Find &amp; Convert, typically <code>/data/certs/client_full.pem</code>.</div>
  </div>
  <div class="mb-3">
    <label for="client_key" class="form-label">Client key (PEM)</label>
    <input id="client_key" name="client_key" value="{{cfg.client_key}}" class="form-control" placeholder="/data/certs/client.key">
    <div class="form-text">Private key that matches the client certificate, e.g. <code>/data/certs/client.key</code>.</div>
  </div>
  <div class="mb-3">
    <label for="client_key_pass" class="form-label">Key passphrase (optional)</label>
    <input id="client_key_pass" type="password" name="client_key_pass" value="{{cfg.client_key_pass}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_p12" class="form-label">Client PKCS#12</label>
    <input id="client_p12" name="client_p12" value="{{cfg.client_p12}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="p12_password" class="form-label">P12 password</label>
    <input id="p12_password" type="password" name="p12_password" value="{{cfg.p12_password}}" class="form-control">
  </div>
  <h4>.NET Bridge</h4>
  <div class="mb-3">
    <label for="dotnet_bridge_path" class="form-label">.NET bridge path</label>
    <input id="dotnet_bridge_path" name="dotnet_bridge_path" value="{{cfg.DOTNET_BRIDGE_PATH}}" class="form-control" placeholder="/bridge/dotnet/VdaaDivBridge/VdaaDivBridge.exe">
    <div class="form-text">Defaults to the mounted bridge path inside the container.</div>
  </div>
  <div class="mb-3">
    <label for="dotnet_cert_pfx_path" class="form-label">.NET client certificate (PFX)</label>
    <input id="dotnet_cert_pfx_path" name="dotnet_cert_pfx_path" value="{{cfg.DOTNET_CERT_PFX_PATH}}" class="form-control" placeholder="/data/certs/client.pfx">
  </div>
  <div class="mb-3">
    <label for="dotnet_cert_pfx_password" class="form-label">.NET PFX password</label>
    <input id="dotnet_cert_pfx_password" type="password" name="dotnet_cert_pfx_password" value="{{cfg.DOTNET_CERT_PFX_PASSWORD}}" class="form-control">
  </div>
  <h4>Java Bridge</h4>
  <div class="mb-3">
    <label for="java_bridge_dir" class="form-label">Java bridge directory</label>
    <input id="java_bridge_dir" name="java_bridge_dir" value="{{cfg.JAVA_BRIDGE_DIR}}" class="form-control" placeholder="/bridge/java/VdaaDivBridge">
  </div>
  <div class="mb-3">
    <label for="java_bridge_lib_dir" class="form-label">Java bridge lib directory</label>
    <input id="java_bridge_lib_dir" name="java_bridge_lib_dir" value="{{cfg.JAVA_BRIDGE_LIB_DIR}}" class="form-control" placeholder="/examples/VDAA_docs/Client/JAVA">
    <div class="form-text">Point this at the SDK jar location so the bridge can run without copying binaries into the repo.</div>
  </div>
  <div class="mb-3">
    <label for="ca_bundle" class="form-label">CA bundle (optional)</label>
    <input id="ca_bundle" name="ca_bundle" value="{{cfg.ca_bundle}}" class="form-control" placeholder="/data/certs/chain.pem">
    <div class="form-text">Point to the issuing chain such as <code>/data/certs/chain.pem</code>, or leave blank to use the system trust store. Never use your client certificate or private key here.</div>
  </div>
  <div class="form-check mb-3">
    <input id="verify_tls" type="checkbox" name="verify_tls" class="form-check-input" {% if cfg.verify_tls %}checked{% endif %}>
    <label for="verify_tls" class="form-check-label">Verify TLS</label>
  </div>
  <div class="mb-3">
    <label for="schema_path" class="form-label">XSD entry</label>
    <input id="schema_path" name="schema_path" value="{{cfg.schema_path}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="success_indicator" class="form-label">Success indicator</label>
    <input id="success_indicator" name="success_indicator" value="{{cfg.success_indicator}}" class="form-control">
  </div>
  <div class="mb-3">
    <label class="form-label">Application users</label>
    <p class="form-text">Manage usernames and passwords allowed to access this tool.</p>
    <div class="table-responsive">
      <table class="table align-middle" id="credential-table">
        <thead>
          <tr>
            <th scope="col">Username</th>
            <th scope="col">Password</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="credential-body"></tbody>
      </table>
    </div>
    <button id="add-credential" type="button" class="btn btn-outline-primary btn-sm">Add user</button>
  </div>
  <input type="hidden" id="auth_credentials" name="auth_credentials">
  <button type="submit" class="btn btn-primary">Save</button>
</form>
<script>
const credentialBody = document.getElementById('credential-body');
const authInput = document.getElementById('auth_credentials');

function addCredentialRow(username = '', password = '') {
  const row = document.createElement('tr');
  row.classList.add('credential-row');

  const userCell = document.createElement('td');
  const userInput = document.createElement('input');
  userInput.className = 'form-control cred-username';
  userInput.value = username;
  userInput.placeholder = 'Username';
  userCell.appendChild(userInput);

  const passCell = document.createElement('td');
  const passInput = document.createElement('input');
  passInput.type = 'password';
  passInput.className = 'form-control cred-password';
  passInput.value = password;
  passInput.placeholder = 'Password';
  passCell.appendChild(passInput);

  const actionCell = document.createElement('td');
  actionCell.className = 'text-end';
  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.className = 'btn btn-outline-danger btn-sm';
  removeBtn.textContent = 'Remove';
  removeBtn.addEventListener('click', () => row.remove());
  actionCell.appendChild(removeBtn);

  row.appendChild(userCell);
  row.appendChild(passCell);
  row.appendChild(actionCell);
  credentialBody.appendChild(row);
}

const initialCredentials = {{ cfg.auth_credentials | tojson | safe }};
if (Array.isArray(initialCredentials) && initialCredentials.length) {
  initialCredentials.forEach((cred) => {
    addCredentialRow(cred.username || '', cred.password || '');
  });
} else {
  addCredentialRow('Administrator', 'invoicetool');
}

document.getElementById('add-credential').addEventListener('click', () => {
  addCredentialRow();
});

document.getElementById('cfg').addEventListener('submit', async (e) => {
  e.preventDefault();
  const credentials = [];
  document.querySelectorAll('#credential-body .credential-row').forEach((row) => {
    const username = row.querySelector('.cred-username').value.trim();
    const password = row.querySelector('.cred-password').value;
    if (username) {
      credentials.push({ username, password });
    }
  });
  authInput.value = JSON.stringify(credentials);
  const fd = new FormData(e.target);
  const res = await fetch('/save-config', { method:'POST', body: fd });
  alert('Saved');
});
</script>
{% endblock %}
