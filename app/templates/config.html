{% extends "base.html" %}{% block content %}
<h2>Configuration</h2>
<h3>Find & Convert (OpenSSL)</h3>
<p>Choose a directory under <code>/data</code> that contains your certificate files.
I will look for: <code>.key</code> (private key), <code>.cer</code>/<code>.pem</code> (client cert), and <code>.p7b</code>/<code>.p7c</code> (chain).</p>
<p><strong>Security:</strong> This tool reads and writes private keys inside <code>/data</code>. Keep that directory local &amp; protected. We don't change key passwords; if your key is encrypted, OpenSSL may prompt for passphrases. The TLS probe uses <code>curl -v</code>; redact logs before sharing.</p>

<form id="finder">
  <label>Search directory (inside /data):
    <input name="dir" value="/data/certs">
  </label>
  <label>Output directory:
    <input name="out" value="/data/certs">
  </label>
  <label>Create PKCS#12 (.p12)
    <input type="checkbox" name="mkp12" checked>
  </label>
  <label>PKCS#12 password (optional)
    <input type="password" name="p12pass" value="">
  </label>
  <div>
    <button type="submit">Find and convert</button>
    <button id="verify" type="button">Verify chain &amp; TLS probe</button>
  </div>
</form>
<pre id="finder_out"></pre>

<script>
document.getElementById('finder').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/tools/find-convert', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('finder_out').textContent = JSON.stringify(js, null, 2);
  if (js.config_applied) alert('Converted and applied to config.');
});

document.getElementById('verify').addEventListener('click', async ()=>{
  const res = await fetch('/tools/verify', { method:'POST' });
  const js = await res.json();
  document.getElementById('finder_out').textContent = JSON.stringify(js, null, 2);
});
</script>
<hr>
<form id="cfg">
  <div class="mb-3">
    <label for="endpoint" class="form-label">Endpoint</label>
    <input id="endpoint" name="endpoint" value="{{cfg.endpoint}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="soap_action" class="form-label">SOAPAction</label>
    <input id="soap_action" name="soap_action" value="{{cfg.soap_action}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="username" class="form-label">Username</label>
    <input id="username" name="username" value="{{cfg.username}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password</label>
    <input id="password" type="password" name="password" value="{{cfg.password}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_cert" class="form-label">Client cert (PEM)</label>
    <input id="client_cert" name="client_cert" value="{{cfg.client_cert}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_key" class="form-label">Client key (PEM)</label>
    <input id="client_key" name="client_key" value="{{cfg.client_key}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="client_p12" class="form-label">Client PKCS#12</label>
    <input id="client_p12" name="client_p12" value="{{cfg.client_p12}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="p12_password" class="form-label">P12 password</label>
    <input id="p12_password" type="password" name="p12_password" value="{{cfg.p12_password}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="ca_bundle" class="form-label">CA bundle (optional)</label>
    <input id="ca_bundle" name="ca_bundle" value="{{cfg.ca_bundle}}" class="form-control">
  </div>
  <div class="form-check mb-3">
    <input id="verify_tls" type="checkbox" name="verify_tls" class="form-check-input" {% if cfg.verify_tls %}checked{% endif %}>
    <label for="verify_tls" class="form-check-label">Verify TLS</label>
  </div>
  <div class="mb-3">
    <label for="schema_path" class="form-label">XSD entry</label>
    <input id="schema_path" name="schema_path" value="{{cfg.schema_path}}" class="form-control">
  </div>
  <div class="mb-3">
    <label for="success_indicator" class="form-label">Success indicator</label>
    <input id="success_indicator" name="success_indicator" value="{{cfg.success_indicator}}" class="form-control">
  </div>
  <button type="submit" class="btn btn-primary">Save</button>
</form>
<script>
document.getElementById('cfg').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/save-config', { method:'POST', body: fd });
  alert('Saved');
});
</script>
{% endblock %}
