{% extends "base.html" %}
{% block content %}
<h2>Invoice (Editor & Validation)</h2>

<p class="muted">Reference prefill: <code>{{ ref_path }}</code></p>

<form id="invForm">
  <fieldset>
    <legend>Header</legend>
    <div class="grid">
      <label>Invoice ID <input name="id" value="{{ prefill.id }}" class="form-control"></label>
      <label>Issue Date <input name="issue_date" value="{{ prefill.issue_date }}" class="form-control"></label>
      <label>Due Date <input name="due_date" value="{{ prefill.due_date }}" class="form-control"></label>
      <label>Type Code <input name="type_code" value="{{ prefill.type_code or '380' }}" class="form-control"></label>
      <label>Currency <input name="currency" value="{{ prefill.currency or 'EUR' }}" class="form-control"></label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Supplier</legend>
    <div class="grid">
      <label>Name <input name="supplier_name" value="{{ prefill.supplier_name }}" class="form-control"></label>
      <label>Company ID <input name="supplier_company_id" value="{{ prefill.supplier_company_id }}" class="form-control"></label>
      <label>VAT Number <input name="supplier_vat" value="{{ prefill.supplier_vat }}" class="form-control"></label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Customer</legend>
    <div class="grid">
      <label>Name <input name="customer_name" value="{{ prefill.customer_name }}" class="form-control"></label>
      <label>Company ID <input name="customer_company_id" value="{{ prefill.customer_company_id }}" class="form-control"></label>
      <label>VAT Number <input name="customer_vat" value="{{ prefill.customer_vat }}" class="form-control"></label>
    </div>
  </fieldset>

  <fieldset id="linesBox">
    <legend>Lines</legend>
    <div id="lines">
      {% for ln in prefill.lines %}
      <div class="line">
        <label>Line ID <input name="lines[{{ loop.index0 }}][id]" value="{{ ln.id }}" class="form-control"></label>
        <label>Name <input name="lines[{{ loop.index0 }}][name]" value="{{ ln.name }}" class="form-control"></label>
        <label>Qty <input name="lines[{{ loop.index0 }}][qty]" value="{{ ln.qty }}" class="form-control"></label>
        <label>Price <input name="lines[{{ loop.index0 }}][price]" value="{{ ln.price }}" class="form-control"></label>
        <label>Line Ext. <input name="lines[{{ loop.index0 }}][line_ext]" value="{{ ln.line_ext }}" class="form-control"></label>
        <button type="button" class="btn btn-danger btn-sm rm">Remove</button>
      </div>
      {% endfor %}
      {% if prefill.lines|length == 0 %}
      <div class="line">
        <label>Line ID <input name="lines[0][id]" value="1" class="form-control"></label>
        <label>Name <input name="lines[0][name]" value="Service" class="form-control"></label>
        <label>Qty <input name="lines[0][qty]" value="1" class="form-control"></label>
        <label>Price <input name="lines[0][price]" value="100.00" class="form-control"></label>
        <label>Line Ext. <input name="lines[0][line_ext]" value="100.00" class="form-control"></label>
        <button type="button" class="btn btn-danger btn-sm rm">Remove</button>
      </div>
      {% endif %}
    </div>
    <button type="button" id="addLine" class="btn btn-secondary">Add line</button>
  </fieldset>

  <fieldset>
    <legend>Totals</legend>
    <div class="grid">
      <label>Tax Amount <input name="tax_amount" value="{{ prefill.tax_amount }}" class="form-control"></label>
      <label>Payable Amount <input name="payable_amount" value="{{ prefill.payable_amount or '100.00' }}" class="form-control"></label>
    </div>
  </fieldset>

  <div class="grid">
    <label>File name (optional) <input name="filename" placeholder="invoice-YYYYMMDD-HHMMSS.xml" class="form-control"></label>
  </div>

  <div class="actions">
    <button type="button" id="gen" class="btn btn-primary">Generate XML</button>
    <button type="button" id="genSave" class="btn btn-secondary">Generate & Save</button>
  </div>
</form>

<h3>XML Preview</h3>
<textarea id="xml" rows="16" style="width:100%" class="form-control"></textarea>

<h3>Validate against XSD</h3>
<div class="grid">
  <label>Schema entrypoint
    <select id="xsd" class="form-select">
      {% for p in xsds %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>
  </label>
</div>
<div class="actions">
  <button type="button" id="validate" class="btn btn-primary">Validate XML</button>
</div>
<pre id="valout"></pre>

<h3>Business Rules (Schematron)</h3>
<div class="grid">
  <label>Ruleset (compiled XSLT)
    <select id="sch">
      <!-- Codex: populate at page load -->
    </select>
  </label>
</div>
<div class="actions">
  <button type="button" id="sch_validate">Validate (Schematron)</button>
</div>
<pre id="schout"></pre>

<style>
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.line{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin:8px 0;padding:8px;border:1px solid #ddd;border-radius:10px}
.actions{display:flex;gap:10px;margin:10px 0}
.muted{opacity:.7}
</style>

<script>
function formToJSON(form){
  const fd = new FormData(form);
  const obj = { lines: [] };
  ['id','issue_date','due_date','type_code','currency',
   'supplier_name','supplier_company_id','supplier_vat',
   'customer_name','customer_company_id','customer_vat',
   'tax_amount','payable_amount','filename'
  ].forEach(k => obj[k] = fd.get(k) || "");
  const lines = {};
  for (const [k,v] of fd.entries()){
    const m = k.match(/^lines\[(\d+)\]\[(\w+)\]$/);
    if (m) {
      const idx = parseInt(m[1],10);
      const key = m[2];
      lines[idx] = lines[idx] || {};
      lines[idx][key] = v;
    }
  }
  obj.lines = Object.keys(lines).sort((a,b)=>a-b).map(i => lines[i]);
  return obj;
}

document.getElementById('addLine').addEventListener('click', ()=>{
  const linesDiv = document.getElementById('lines');
  const idx = linesDiv.querySelectorAll('.line').length;
  const wrapper = document.createElement('div');
  wrapper.className = 'line';
  wrapper.innerHTML = `
    <label>Line ID <input name="lines[${idx}][id]" value="${idx+1}" class="form-control"></label>
    <label>Name <input name="lines[${idx}][name]" value="" class="form-control"></label>
    <label>Qty <input name="lines[${idx}][qty]" value="1" class="form-control"></label>
    <label>Price <input name="lines[${idx}][price]" value="0.00" class="form-control"></label>
    <label>Line Ext. <input name="lines[${idx}][line_ext]" value="0.00" class="form-control"></label>
    <button type="button" class="btn btn-danger btn-sm rm">Remove</button>
  `;
  linesDiv.appendChild(wrapper);
  wrapper.querySelector('.rm').addEventListener('click', ()=> wrapper.remove());
});
Array.from(document.querySelectorAll('.line .rm')).forEach(btn => btn.addEventListener('click', ()=> btn.closest('.line').remove()));

async function doGenerate(save){
  const data = formToJSON(document.getElementById('invForm'));
  const fd = new FormData();
  fd.append('payload', JSON.stringify(data));
  fd.append('save', save ? 'true' : 'false');
  fd.append('filename', data.filename || '');
  const res = await fetch('/invoice/generate', { method:'POST', body: fd });
  const js = await res.json();
  if (js.ok){
    document.getElementById('xml').value = js.xml || '';
    if (js.saved_to) alert("Saved to: " + js.saved_to);
  } else {
    alert("Generation failed: " + (js.error || ''));
  }
}
document.getElementById('gen').addEventListener('click', ()=> doGenerate(false));
document.getElementById('genSave').addEventListener('click', ()=> doGenerate(true));

document.getElementById('validate').addEventListener('click', async ()=>{
  const xml = document.getElementById('xml').value;
  const xsd = document.getElementById('xsd').value;
  const fd = new FormData();
  fd.append('xml_text', xml);
  fd.append('xsd_path', xsd);
  const res = await fetch('/invoice/validate', { method:'POST', body: fd });
  const js = await res.json();
  document.getElementById('valout').textContent = JSON.stringify(js, null, 2);
});

// populate ruleset dropdown
(async function(){
  try {
    const r = await fetch('/schematron/list');
    const js = await r.json();
    const sel = document.getElementById('sch');
    (js.rulesets || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p; opt.textContent = p;
      sel.appendChild(opt);
    });
  } catch(e) { console.warn(e); }
})();

document.getElementById('sch_validate').addEventListener('click', async ()=>{
  const xml = document.getElementById('xml').value;
  const sch = document.getElementById('sch').value;
  const fd = new FormData();
  fd.append('invoice_xml', xml);
  fd.append('ruleset_path', sch);
  const res = await fetch('/schematron/validate', { method:'POST', body: fd });
  const js = await res.json();
  const summary = (js.ok ? "OK" : "FAILED") + " â€” " + (js.issues||[]).length + " messages";
  document.getElementById('schout').textContent = summary + "\n\n" + (js.issues||[]).join("\n");
});
</script>
{% endblock %}
