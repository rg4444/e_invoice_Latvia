{% extends "base.html" %}
{% block content %}
<h2>Address Lists</h2>
<p class="mb-2">Use the UnifiedService operations to download the addressee lists. The downloaded XML responses are stored in <code>{{ addresses_dir }}</code>.</p>
<p class="text-muted small mb-4">
  Start <strong>GetInitialAddresseeRecordList</strong> with an empty Token and reuse the returned next token to fetch subsequent pages.
  For <strong>GetChangedAddresseeRecordList</strong>, provide the <em>MaxVersion</em> value from your last successful batch as <em>LastVersion</em>.
</p>

<div class="mb-3">
  <label class="form-label" for="soap_engine">SOAP Engine</label>
  <select id="soap_engine" class="form-select">
    <option value="python" selected>Python (custom WSSE)</option>
    <option value="dotnet">.NET (VDAA SDK)</option>
    <option value="java">Java (VDAA SDK)</option>
  </select>
  <div class="form-text">
    Use .NET/Java for official VDAA SDK behaviour; use Python for custom experiments.
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Initial Addressee Record List</h5>
    <p class="card-text">Fetch the full addressee list. Leave Token blank on the very first call, then reuse the returned Next token to continue paging.</p>
    <div class="mb-3">
      <label class="form-label" for="addr_token">Token</label>
      <input id="addr_token" class="form-control" placeholder="Enter token (optional on first call)">
      <div class="form-text">Use the <code>next_token</code> from the previous response for follow-up requests.</div>
    </div>
    <button id="addr_initial" class="btn btn-primary">Download initial list</button>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Incremental Addressee Record List</h5>
    <p class="card-text">Request only the changes since a specific version. Supply the highest <code>MaxVersion</code> you have previously received.</p>
    <div class="mb-3">
      <label class="form-label" for="addr_version">Last version</label>
      <input id="addr_version" class="form-control" type="number" min="0" step="1" placeholder="Enter last version">
      <div class="form-text">Usually the <code>max_version</code> reported in the last changed batch.</div>
    </div>
    <button id="addr_changed" class="btn btn-secondary">Download incremental list</button>
  </div>
</div>

<div class="mb-3">
  <label class="form-label" for="addr_endpoint">Service endpoint</label>
  <input id="addr_endpoint" class="form-control" value="{{ cfg.endpoint }}" readonly>
</div>

<pre id="addr_result"
     class="bg-dark text-light p-3 rounded small"
     style="max-height: 360px; overflow-y: auto; font-family: monospace;"
     hidden></pre>

<script>
(function(){
  const resultBox = document.getElementById('addr_result');
  const initialBtn = document.getElementById('addr_initial');
  const changedBtn = document.getElementById('addr_changed');

  function showResult(data) {
    resultBox.hidden = false;

    if (!data) {
      resultBox.textContent = "No response.";
      return;
    }

    let lines = [];

    if (data.engine || data.operation) {
      lines.push("Engine: " + (data.engine || "?") + " | Operation: " + (data.operation || "?"));
    }
    if (data.endpoint || data.endpoint_mode) {
      lines.push("Endpoint: " + (data.endpoint || "?") + " (" + (data.endpoint_mode || "normal") + ")");
    }
    if (data.sent_utc || data.message_id) {
      lines.push("Sent: " + (data.sent_utc || "?") + " | MessageID: " + (data.message_id || "?"));
    }
    if (typeof data.http_status !== "undefined" || typeof data.took_ms !== "undefined") {
      lines.push("HTTP status: " + (data.http_status ?? "?") + " | Duration: " + (data.took_ms ?? "?") + " ms");
    }
    if (data.request_saved_path) lines.push("Saved request: " + data.request_saved_path);
    if (data.response_saved_path) lines.push("Saved response: " + data.response_saved_path);
    if (data.parsed_saved_path) lines.push("Saved parsed list: " + data.parsed_saved_path);

    const summary = data.summary || {};
    if (summary.addressee_count) lines.push("Addressee records in this batch: " + summary.addressee_count);
    if (summary.next_token) lines.push("Next token for paging: " + summary.next_token);
    if (typeof summary.max_version !== "undefined") lines.push("MaxVersion for delta: " + summary.max_version);

    if (data.fault_reason) lines.push("Fault reason: " + data.fault_reason);
    if (data.fault_code) lines.push("Fault code: " + data.fault_code);
    if (data.stderr) lines.push("stderr: " + data.stderr);
    if (data.error) lines.push("Error: " + data.error);

    const summary = lines.join("\n");
    const raw = JSON.stringify(data, null, 2);

    resultBox.textContent = summary + "\n\n--- Raw JSON ---\n" + raw;
  }

  async function callEndpoint(url, formData, button) {
    button.disabled = true;
    resultBox.hidden = false;
    resultBox.textContent = "Calling " + url + "...";
    try {
      const response = await fetch(url, { method: "POST", body: formData });
      let data;
      try {
        data = await response.json();
      } catch (err) {
        data = { ok: false, error: "Failed to parse server response" };
      }
      if (typeof data.http_status_client === "undefined") {
        data.http_status_client = response.status;
      }
      showResult(data);
    } catch (err) {
      showResult({ ok: false, error: err && err.message ? err.message : String(err) });
    } finally {
      button.disabled = false;
    }
  }

  initialBtn.addEventListener('click', () => {
    const token = document.getElementById('addr_token').value.trim();
    const engine = document.getElementById('soap_engine').value;
    const fd = new FormData();
    fd.append('engine', engine);
    fd.append('operation', 'GetInitialAddresseeRecordList');
    fd.append('token', token);
    fd.append('endpoint_mode', 'normal');
    fd.append('save_raw', 'true');
    fd.append('parse', 'true');
    callEndpoint('/api/soap/call', fd, initialBtn);
  });

  changedBtn.addEventListener('click', () => {
    const version = document.getElementById('addr_version').value.trim();
    const engine = document.getElementById('soap_engine').value;
    const fd = new FormData();
    fd.append('engine', engine);
    fd.append('operation', 'GetChangedAddresseeRecordList');
    fd.append('token', version);
    fd.append('endpoint_mode', 'normal');
    fd.append('save_raw', 'true');
    fd.append('parse', 'true');
    callEndpoint('/api/soap/call', fd, changedBtn);
  });
})();
</script>
{% endblock %}
